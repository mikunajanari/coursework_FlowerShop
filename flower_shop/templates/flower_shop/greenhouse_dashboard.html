{% load static %}
<!DOCTYPE html>
<html lang="uk">

<head>
  <meta charset="utf-8">
  <title>–ü—Ä–∞—Ü—ñ–≤–Ω–∏–∫ —Ç–µ–ø–ª–∏—Ü—å</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="{% static 'plugins/bootstrap/css/bootstrap.min.css' %}">
  <link rel="stylesheet" href="{% static 'plugins/themefisher-font/style.css' %}">
  <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>

<body>
  <!-- –®–∞–ø–∫–∞ -->
  <section class="top-header">
    <div class="container">
      <div class="row">
        <div class="col-md-4">üìû –ö–æ–Ω—Ç–∞–∫—Ç–∏: +380-00-000-0000</div>
        <div class="col-md-4 text-center"><strong>EVERGREEN</strong></div>
        <div class="col-md-4 text-right">
          <span>üë§ <span id="user-role">–ü—Ä–∞—Ü—ñ–≤–Ω–∏–∫ —Ç–µ–ø–ª–∏—Ü—å</span></span>
          <button class="btn btn-sm btn-outline-danger ml-2" id="logout-btn">–í–∏–π—Ç–∏</button>
        </div>
      </div>
    </div>
  </section>

  <!-- –ö–æ–Ω—Ç–µ–Ω—Ç -->
  <section class="section">
    <div class="container">
      <h2 class="text-center">üåø –ü–∞–Ω–µ–ª—å –ü—Ä–∞—Ü—ñ–≤–Ω–∏–∫–∞ —Ç–µ–ø–ª–∏—Ü—å</h2>


      <form id="planting-form">
  <h4>üå± –ü–æ—Å–∞–¥–∫–∞ –∫–≤—ñ—Ç—ñ–≤ + üíß –î–æ–±—Ä–∏–≤–æ</h4>
  <div class="row">
    <div class="col-md-3">
      <label>–†—ñ–¥ –∫–≤—ñ—Ç–∫–∏</label>
      <input list="flower-genus-list" id="genus-input" class="form-control" required>
      <datalist id="flower-genus-list"></datalist>
    </div>
    <div class="col-md-3">
      <label>–í–∏–¥ –∫–≤—ñ—Ç–∫–∏</label>
      <input list="flower-species-list" id="species-input" class="form-control" required>
      <datalist id="flower-species-list"></datalist>
    </div>
    <div class="col-md-2">
      <label>–ö—ñ–ª—å–∫—ñ—Å—Ç—å –∫–≤—ñ—Ç—ñ–≤</label>
      <input type="number" id="planting-count" class="form-control" required>
    </div>
    <div class="col-md-2">
      <label>–î–æ–±—Ä–∏–≤–æ</label>
      <select id="fertilizer-select" class="form-control" required></select>
    </div>
    <div class="col-md-2">
      <label>–ö-—Å—Ç—å –¥–æ–±—Ä–∏–≤–∞</label>
      <input type="number" id="fertilizer-amount" class="form-control" min="1" required>
    </div>
  </div>

  <button class="btn btn-success mt-3">üåø –ü–æ—Å–∞–¥–∏—Ç–∏</button>
</form>

<div id="planting-result" class="mt-2"></div>



      <h4 class="mt-5">‚úÖ –í—ñ–¥–º—ñ—Ç–∏—Ç–∏ –≥–æ—Ç–æ–≤–Ω—ñ—Å—Ç—å —Ä–æ—Å–ª–∏–Ω</h4>
      <table class="table">
        <thead>
          <tr>
            <th>–†—ñ–¥</th>
            <th>–í–∏–¥</th>
            <th>–ö—ñ–ª—å–∫—ñ—Å—Ç—å</th>
            <th>–î–∞—Ç–∞ –ø–æ—Å–∞–¥–∫–∏</th>
            <th>–î—ñ—ó</th>
          </tr>
        </thead>
        <tbody id="ready-plants-table">
          <!-- –î–∏–Ω–∞–º—ñ—á–Ω–∏–π —Å–ø–∏—Å–æ–∫ -->
        </tbody>
      </table>


      <h4 class="mt-5">üóëÔ∏è –°–ø–∏—Å–∞–Ω–Ω—è —Ä–æ—Å–ª–∏–Ω</h4>
      <table class="table">
        <thead>
          <tr>
            <th>–†—ñ–¥</th>
            <th>–í–∏–¥</th>
            <th>–ö—ñ–ª—å–∫—ñ—Å—Ç—å</th>
            <th>–î–∞—Ç–∞ –ø–æ—Å–∞–¥–∫–∏</th>
            <th>–î—ñ—ó</th>
          </tr>
        </thead>
        <tbody id="remove-plants-table">
          <!-- –î–∏–Ω–∞–º—ñ—á–Ω–∏–π —Å–ø–∏—Å–æ–∫ -->
        </tbody>
      </table>

    </div>
  </section>

  <footer class="footer text-center">
    <div class="container">
      <p class="copyright-text">¬© 2025 EVERGREEN</p>
    </div>
  </footer>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      fetch('/api/plants/available') // –ö–≤—ñ—Ç–∏
        .then(res => res.json())
        .then(data => {
          const select = document.getElementById("flower-select");
          data.forEach(item => {
            const opt = document.createElement("option");
            opt.value = item.id;
            opt.textContent = `${item.genus} ${item.species} (–ø–æ—Å–∞–¥–∂–µ–Ω–æ ${item.quantity})`;
            select.appendChild(opt);
          });
        });

      fetch('/api/fertilizer/list') // –î–æ–±—Ä–∏–≤–∞
        .then(res => res.json())
        .then(data => {
          const select = document.getElementById("fertilizer-select");
          data.forEach(item => {
            const opt = document.createElement("option");
            opt.value = item.id;
            opt.textContent = `${item.name} (${item.supplier})`;
            select.appendChild(opt);
          });
        });

      // –û–±—Ä–æ–±–∫–∞ —Ñ–æ—Ä–º–∏
      document.getElementById("fertilizer-form").addEventListener("submit", e => {
        e.preventDefault();

        const payload = {
          flowerId: document.getElementById("flower-select").value,
          fertilizerId: document.getElementById("fertilizer-select").value,
          amount: parseInt(document.getElementById("fertilizer-amount").value),
        };

        fetch('/api/fertilizer/use', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        }).then(res => {
          if (res.ok) {
            document.getElementById("fertilizer-result").innerHTML = `<div class="alert alert-success">üå± –î–æ–±—Ä–∏–≤–æ –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ —É—Å–ø—ñ—à–Ω–æ!</div>`;
          } else {
            document.getElementById("fertilizer-result").innerHTML = `<div class="alert alert-danger">‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ!</div>`;
          }
        });
      });
    });

    document.addEventListener("DOMContentLoaded", () => {
  // ü™¥ –û–±—Ä–æ–±–∫–∞ –ø–æ—Å–∞–¥–∫–∏ –∫–≤—ñ—Ç—ñ–≤
  document.getElementById("planting-form").addEventListener("submit", e => {
    e.preventDefault();
    const speciesName = document.getElementById("species-input").value.trim();
    const quantity = parseInt(document.getElementById("planting-count").value);

    // ‚ö†Ô∏è –ü–æ—Ç—Ä—ñ–±–Ω–æ –∑–Ω–∞–π—Ç–∏ species_id –∑–∞ –Ω–∞–∑–≤–æ—é (–º–æ–∂–Ω–∞ –∑–±–µ—Ä—ñ–≥–∞—Ç–∏ –≤ map –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ, —Ç—É—Ç ‚Äî —Å–ø—Ä–æ—â–µ–Ω–æ)
    fetch("/api/species/list")
      .then(res => res.json())
      .then(speciesList => {
        const match = speciesList.find(s => s.name === speciesName);
        if (!match) return alert("–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ —Ç–∞–∫–∏–π –≤–∏–¥ –∫–≤—ñ—Ç–∫–∏!");

        fetch("/api/plant", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            species_id: match.id,
            quantity: quantity
          })
        }).then(res => {
          if (res.ok) {
            document.getElementById("planting-result").innerHTML =
              `<div class="alert alert-success">‚úÖ –ü–æ—Å–∞–¥–∫—É –≤–∏–∫–æ–Ω–∞–Ω–æ —É—Å–ø—ñ—à–Ω–æ</div>`;
          } else {
            res.text().then(text => alert("‚ùå –ü–æ–º–∏–ª–∫–∞: " + text));
          }
        });
      });
  });

  // ‚úÖ –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ä–æ—Å–ª–∏–Ω–∏ –¥–ª—è –≤—ñ–¥–º—ñ—Ç–∫–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—ñ
  fetch("/api/plants/unready")
    .then(res => res.json())
    .then(plants => {
      const tbody = document.getElementById("ready-plants-table");
      plants.forEach(p => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${p.genus}</td>
          <td>${p.species}</td>
          <td>${p.amount}</td>
          <td>${p.planting_day}</td>
          <td>
            <button class="btn btn-sm btn-outline-success" data-id="${p.id}">‚úÖ –ì–æ—Ç–æ–≤–æ</button>
          </td>`;
        tbody.appendChild(row);
      });

      tbody.querySelectorAll("button").forEach(btn => {
        btn.addEventListener("click", () => {
          const plantedId = btn.dataset.id;
          fetch("/api/ready", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ planted_id: plantedId })
          }).then(res => {
            if (res.ok) {
              btn.textContent = "‚úÖ –í—ñ–¥–º—ñ—á–µ–Ω–æ";
              btn.disabled = true;
            } else {
              res.text().then(text => alert("‚ùå –ü–æ–º–∏–ª–∫–∞: " + text));
            }
          });
        });
      });
    });

  // üóëÔ∏è –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Å–ø–∏—Å–æ–∫ –¥–ª—è —Å–ø–∏—Å–∞–Ω–Ω—è
  fetch("/api/plants/available_for_writeoff")
    .then(res => res.json())
    .then(plants => {
      const tbody = document.getElementById("remove-plants-table");
      plants.forEach(p => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${p.genus}</td>
          <td>${p.species}</td>
          <td>${p.amount}</td>
          <td>${p.planting_day}</td>
          <td>
            <input type="number" min="1" max="${p.amount}" placeholder="–ö—ñ–ª—å–∫—ñ—Å—Ç—å" class="form-control form-control-sm mb-1 writeoff-count">
            <button class="btn btn-sm btn-outline-danger" data-id="${p.id}">üóëÔ∏è –°–ø–∏—Å–∞—Ç–∏</button>
          </td>`;
        tbody.appendChild(row);
      });

      tbody.querySelectorAll("button").forEach(btn => {
        btn.addEventListener("click", () => {
          const plantedId = btn.dataset.id;
          const input = btn.parentElement.querySelector(".writeoff-count");
          const count = parseInt(input.value);
          if (!count || count <= 0) return alert("–í–∫–∞–∂—ñ—Ç—å –∫—ñ–ª—å–∫—ñ—Å—Ç—å –¥–ª—è —Å–ø–∏—Å–∞–Ω–Ω—è");

          fetch("/api/writeoff", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ planted_id: plantedId, quantity: count })
          }).then(res => {
            if (res.ok) {
              btn.textContent = "‚úÖ –°–ø–∏—Å–∞–Ω–æ";
              btn.disabled = true;
              input.disabled = true;
            } else {
              res.text().then(text => alert("‚ùå –ü–æ–º–∏–ª–∫–∞: " + text));
            }
          });
        });
      });
    });
});



document.addEventListener("DOMContentLoaded", () => {
  let speciesData = [];
  let genusFertilizerMap = {}; // –∫–ª—é—á: genus_id, –∑–Ω–∞—á–µ–Ω–Ω—è: [{id, name, supplier}]

  // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ä–æ–¥—ñ–≤ —ñ –≤–∏–¥—ñ–≤
  fetch('/api/species')
    .then(res => res.json())
    .then(data => {
      speciesData = data;

      const genusSet = new Set();
      const genusDatalist = document.getElementById("flower-genus-list");
      const speciesDatalist = document.getElementById("flower-species-list");

      data.forEach(({ id, name, genus, genus_id }) => {
        if (!genusSet.has(genus)) {
          const opt = document.createElement("option");
          opt.value = genus;
          genusDatalist.appendChild(opt);
          genusSet.add(genus);
        }

        const opt2 = document.createElement("option");
        opt2.value = name;
        opt2.setAttribute("data-species-id", id);
        opt2.setAttribute("data-genus-id", genus_id);
        speciesDatalist.appendChild(opt2);
      });
    });

  // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤—Å—ñ—Ö –¥–æ–±—Ä–∏–≤ –∑–≥—Ä—É–ø–æ–≤–∞–Ω–∏—Ö –ø–æ —Ä–æ–¥—É
  fetch('/api/fertilizer/grouped')
    .then(res => res.json())
    .then(data => {
      genusFertilizerMap = data;
    });

  // –ü—Ä–∏ –≤–∏–±–æ—Ä—ñ –≤–∏–¥—É - –æ–Ω–æ–≤–ª—é—î–º–æ —Å–ø–∏—Å–æ–∫ –¥–æ–±—Ä–∏–≤
  document.getElementById("species-input").addEventListener("input", () => {
    const speciesInput = document.getElementById("species-input").value;
    const match = speciesData.find(s => s.name === speciesInput);

    const fertSelect = document.getElementById("fertilizer-select");
    fertSelect.innerHTML = `<option value="">-- –û–±–µ—Ä—ñ—Ç—å –¥–æ–±—Ä–∏–≤–æ --</option>`;

    if (match && genusFertilizerMap[match.genus_id]) {
      genusFertilizerMap[match.genus_id].forEach(f => {
        const opt = document.createElement("option");
        opt.value = f.id;
        opt.textContent = `${f.name} (${f.supplier})`;
        fertSelect.appendChild(opt);
      });
    }
  });

  // –í—ñ–¥–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º–∏ –ø–æ—Å–∞–¥–∫–∏
  document.getElementById("planting-form").addEventListener("submit", e => {
    e.preventDefault();

    const speciesName = document.getElementById("species-input").value;
    const species = speciesData.find(s => s.name === speciesName);

    const payload = {
      species_id: species.id,
      quantity: parseInt(document.getElementById("planting-count").value),
      genus_fertilizer_id: parseInt(document.getElementById("fertilizer-select").value),
      fertilizer_amount: parseInt(document.getElementById("fertilizer-amount").value)
    };

    fetch('/api/plants/plant-with-fertilizer', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    }).then(res => {
      if (res.ok) {
        document.getElementById("planting-result").innerHTML = `<div class="alert alert-success">‚úÖ –ü–æ—Å–∞–¥–∫–∞ –∑ –¥–æ–±—Ä–∏–≤–æ–º —É—Å–ø—ñ—à–Ω–∞</div>`;
      } else {
        document.getElementById("planting-result").innerHTML = `<div class="alert alert-danger">‚ùå –ü–æ–º–∏–ª–∫–∞</div>`;
      }
    });
  });
});
  </script>

<script src="{% static 'plugins/jquery/dist/jquery.min.js' %}"></script>
<script src="{% static 'plugins/bootstrap/js/bootstrap.min.js' %}"></script>
<script src="{% static 'js/script.js' %}"></script>
</body>

</html>
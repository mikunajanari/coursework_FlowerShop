{% extends "flower_shop/worker_base.html" %}
{% load static %}

{% block worker_title %}–ü–∞–Ω–µ–ª—å –ú–µ–Ω–µ–¥–∂–µ—Ä–∞{% endblock %}
{% block worker_role %}–ú–µ–Ω–µ–¥–∂–µ—Ä{% endblock %}

{% block worker_content %}

      <form id="add-client-form">
        <h4>–î–æ–¥–∞—Ç–∏ –∫–ª—ñ—î–Ω—Ç–∞</h4>
        <input class="form-control" placeholder="–ü–Ü–ë" id="client-name" required>
        <input class="form-control mt-2" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" id="client-phone" required>
        <input class="form-control mt-2" placeholder="Email" id="client-email">
        <input class="form-control mt-2" placeholder="–ê–¥—Ä–µ—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏" id="client-a ddress">
        <button type="submit" class="btn btn-success mt-3">‚ûï –î–æ–¥–∞—Ç–∏ –∫–ª—ñ—î–Ω—Ç–∞</button>
      </form>
      <div id="client-result" class="mt-2"></div>

      <script>
        document.getElementById("add-client-form").addEventListener("submit", (e) => {
          e.preventDefault();
          const body = {
            name: clientName.value,
            phone: clientPhone.value,
            email: clientEmail.value,
            address: clientAddress.value
          };
          fetch("/api/clients", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
          }).then(res => res.json())
            .then(data => {
              clientResult.innerHTML = `‚úÖ ID –Ω–æ–≤–æ–≥–æ –∫–ª—ñ—î–Ω—Ç–∞: ${data.id}`;
            });
        });
      </script>

      <form id="create-order-form">
        <h4>üìù –°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</h4>
        <label for="client-select">–û–±–µ—Ä—ñ—Ç—å –∫–ª—ñ—î–Ω—Ç–∞:</label>
        <select class="form-control" id="client-select">
          <!-- –î–∏–Ω–∞–º—ñ—á–Ω–æ –∑–∞–ø–æ–≤–Ω—é—î—Ç—å—Å—è –∑ –ë–î -->
        </select>
        <input type="date" class="form-control mt-2" id="order-date" required>
        <button class="btn btn-primary mt-2">‚ûï –°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</button>
      </form>
      <div id="order-result" class="mt-2"></div>

      <script>
        document.getElementById("create-order-form").addEventListener("submit", (e) => {
          e.preventDefault();
          const body = {
            clientId: orderClientId.value,
            deliveryDate: orderDate.value
          };
          fetch("/api/orders", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
          }).then(res => res.json())
            .then(data => {
              orderResult.innerHTML = `üßæ ID –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è: ${data.id}`;
            });
        });
        // –ü—ñ–¥–≥—Ä—É–∑–∫–∞ –∫–ª—ñ—î–Ω—Ç—ñ–≤ –∑ –±–µ–∫–µ–Ω–¥—É
        fetch('/api/clients')
          .then(res => res.json())
          .then(data => {
            const select = document.getElementById("client-select");
            data.forEach(client => {
              const option = document.createElement("option");
              option.value = client.id;
              option.textContent = `${client.name} | ${client.phone}`;
              select.appendChild(option);
            });
          });

      </script>

      <form id="add-item-form">
        <h4>üåº –î–æ–¥–∞—Ç–∏ —Ç–æ–≤–∞—Ä –¥–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</h4>
        <table id="orders-table" class="table table-bordered">
          <thead>
            <tr>
              <th>–ù–æ–º–µ—Ä</th>
              <th>–ö–ª—ñ—î–Ω—Ç</th>
              <th>–î–∞—Ç–∞</th>
              <th>–î—ñ—è</th>
            </tr>
          </thead>
          <tbody id="orders-body"></tbody>
        </table>
        <label for="flower-select">–û–±–µ—Ä—ñ—Ç—å –∫–≤—ñ—Ç–∫—É:</label>
        <select class="form-control" id="flower-select">
          <!-- –î–∏–Ω–∞–º—ñ—á–Ω–æ -->
        </select>
        <input type="number" class="form-control mt-2" placeholder="–ö—ñ–ª—å–∫—ñ—Å—Ç—å" id="item-qty" required>
        <button class="btn btn-warning mt-2">‚ûï –î–æ–¥–∞—Ç–∏ —Ç–æ–≤–∞—Ä</button>
      </form>
      <div id="item-result" class="mt-2"></div>

      <script>
        fetch('/api/flowers')
          .then(res => res.json())
          .then(data => {
            const select = document.getElementById("flower-select");
            data.forEach(flower => {
              const option = document.createElement("option");
              option.value = flower.id; // –∞–±–æ `${flower.name}|${flower.sort}`
              option.textContent = `${flower.name} - ${flower.sort} (${flower.qty}—à—Ç)`;
              select.appendChild(option);
            });
          });
      </script>

      <form id="check-stock-form">
        <h4>üîç –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å</h4>
        <label for="flower-select">–û–±–µ—Ä—ñ—Ç—å –∫–≤—ñ—Ç–∫—É:</label>
        <select class="form-control" id="flower-select">
          <!-- –î–∏–Ω–∞–º—ñ—á–Ω–æ -->
        </select>
        <button class="btn btn-info mt-2">üîç –ü–æ—à—É–∫</button>
      </form>
      <div id="stock-result" class="mt-2"></div>

      <form id="track-order-form">
        <h4>üì¶ –°—Ç–∞—Ç—É—Å –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</h4>
        <input class="form-control" placeholder="–ù–æ–º–µ—Ä –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è" id="track-order-id" required>
        <table id="orders-table" class="table table-bordered">
          <thead>
            <tr>
              <th>–ù–æ–º–µ—Ä</th>
              <th>–ö–ª—ñ—î–Ω—Ç</th>
              <th>–î–∞—Ç–∞</th>
              <th>–î—ñ—è</th>
            </tr>
          </thead>
          <tbody id="orders-body"></tbody>
        </table>
      </form>
      <div id="track-result" class="mt-2"></div>

      <form id="season-stats-form">
        <h4>üå§ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å–µ–∑–æ–Ω–∞—Ö</h4>
        <input class="form-control" type="number" min="2020" id="season-year" required
          placeholder="–†—ñ–∫ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, 2024)">
        <button class="btn btn-outline-success mt-2">üìä –û—Ç—Ä–∏–º–∞—Ç–∏</button>
      </form>
      <div id="season-result" class="mt-2"></div>

      <form id="client-pref-form">
        <h4>üíñ –ê–Ω–∞–ª—ñ–∑ –≤–ø–æ–¥–æ–±–∞–Ω—å</h4>
        <label for="client-select">–û–±–µ—Ä—ñ—Ç—å –∫–ª—ñ—î–Ω—Ç–∞:</label>
        <select class="form-control" id="client-select">
          <!-- –î–∏–Ω–∞–º—ñ—á–Ω–æ –∑–∞–ø–æ–≤–Ω—é—î—Ç—å—Å—è –∑ –ë–î -->
        </select>
        <button class="btn btn-outline-warning mt-2">üìà –ê–Ω–∞–ª—ñ–∑</button>
      </form>
      <div id="pref-result" class="mt-2"></div>

      <form id="top-clients-form">
        <h4>üèÜ –¢–æ–ø –∫–ª—ñ—î–Ω—Ç—ñ–≤</h4>
        <input type="date" class="form-control" id="top-start" required>
        <input type="date" class="form-control mt-2" id="top-end" required>
        <button class="btn btn-dark mt-2">üìã –ü–æ–∫–∞–∑–∞—Ç–∏</button>
      </form>
      <div id="top-clients-result" class="mt-2"></div>
{% endblock %}

{% block worker_scripts %}
  <script>
    let clients = []; // –¢—É—Ç –±—É–¥–µ —Å–ø–∏—Å–æ–∫ –∑ –±–µ–∫–µ–Ω–¥—É
    let currentPage = 1;

    async function fetchClients(search = '', limit = 10, page = 1) {
      // üëá –¢—É—Ç –º–∞—î –±—É—Ç–∏ —Ç–≤—ñ–π fetch –∑ –±–µ–∫–µ–Ω–¥—É (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥ —á–µ—Ä–µ–∑ API)
      // –ü–æ–∫–∏ —â–æ ‚Äî –∑–∞–≥–ª—É—à–∫–∞:
      const response = await fetch(`/api/clients?search=${search}&limit=${limit}&page=${page}`);
      const data = await response.json(); // [{id, name, phone, email, address}]
      clients = data.clients || [];
      renderClientTable(clients);
      renderPagination(data.total, limit, page);
    }

    function renderClientTable(clients) {
      const tbody = document.getElementById("client-table-body");
      tbody.innerHTML = "";
      for (const c of clients) {
        const row = `<tr>
        <td>${c.id}</td>
        <td>${c.name}</td>
        <td>${c.phone}</td>
        <td>${c.email}</td>
        <td>${c.address}</td>
      </tr>`;
        tbody.insertAdjacentHTML("beforeend", row);
      }
    }

    function renderPagination(total, limit, page) {
      const pages = Math.ceil(total / limit);
      const pagination = document.getElementById("pagination");
      pagination.innerHTML = "";
      for (let i = 1; i <= pages; i++) {
        const li = document.createElement("li");
        li.className = `page-item ${i === page ? 'active' : ''}`;
        li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
        li.onclick = (e) => {
          e.preventDefault();
          currentPage = i;
          fetchClients(document.getElementById("search-client").value, parseInt(document.getElementById("client-limit").value), i);
        };
        pagination.appendChild(li);
      }
    }

    // üîç –ü–æ—à—É–∫
    document.getElementById("search-client").addEventListener("input", () => {
      fetchClients(document.getElementById("search-client").value, parseInt(document.getElementById("client-limit").value), 1);
    });

    // ‚è´ –õ—ñ–º—ñ—Ç –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫—É
    document.getElementById("client-limit").addEventListener("change", () => {
      fetchClients(document.getElementById("search-client").value, parseInt(document.getElementById("client-limit").value), 1);
    });

    // ‚ûï –î–æ–¥–∞—Ç–∏ –∫–ª—ñ—î–Ω—Ç–∞
    document.getElementById("add-client-form").addEventListener("submit", async function (e) {
      e.preventDefault();
      const client = {
        name: document.getElementById("new-client-name").value,
        phone: document.getElementById("new-client-phone").value,
        email: document.getElementById("new-client-email").value,
        address: document.getElementById("new-client-address").value
      };

      const res = await fetch("/api/clients", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(client)
      });

      const newClient = await res.json(); // –æ—á—ñ–∫—É—î–º–æ {id, ...}

      const msg = document.getElementById("client-added-msg");
      msg.classList.remove("d-none");
      msg.innerText = `–ö–ª—ñ—î–Ω—Ç–∞ —Å—Ç–≤–æ—Ä–µ–Ω–æ! ID: ${newClient.id}`;

      // –û–Ω–æ–≤–∏—Ç–∏ —Ç–∞–±–ª–∏—Ü—é
      fetchClients('', parseInt(document.getElementById("client-limit").value), currentPage);
      e.target.reset();
    });

    // üöÄ –ü–æ—á–∞—Ç–∫–æ–≤–∏–π —Ä–µ–Ω–¥–µ—Ä
    fetchClients();
  </script>

  <script>
    const today = new Date().toISOString().split("T")[0];
    document.getElementById("delivery-date").setAttribute("min", today);

    const flowerList = [];

    document.getElementById("add-flower-btn").addEventListener("click", function (e) {
      e.preventDefault();

      const genus = document.getElementById("flower-genus").value.trim();
      const species = document.getElementById("flower-species").value.trim();
      const quantity = document.getElementById("flower-quantity").value;

      if (!genus || !species || !quantity || quantity <= 0) {
        alert("–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø–æ–≤–Ω–∏ –≤—Å—ñ –ø–æ–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ!");
        return;
      }

      const table = document.getElementById("order-table").querySelector("tbody");
      const row = table.insertRow();
      row.innerHTML = `
      <td>${genus}</td>
      <td>${species}</td>
      <td>${quantity}</td>
      <td><button class="btn btn-danger btn-sm remove-row">‚úñ</button></td>
    `;

      flowerList.push({ genus, species, quantity });

      // –û—á–∏—Å—Ç–∏—Ç–∏ –ø–æ–ª—è
      document.getElementById("flower-genus").value = "";
      document.getElementById("flower-species").value = "";
      document.getElementById("flower-quantity").value = "";
    });

    document.getElementById("order-table").addEventListener("click", function (e) {
      if (e.target.classList.contains("remove-row")) {
        const row = e.target.closest("tr");
        const index = row.rowIndex - 1;
        row.remove();
        flowerList.splice(index, 1);
      }
    });

    document.getElementById("submit-order-btn").addEventListener("click", function () {
      const clientId = document.getElementById("client-id").value.trim();
      const deliveryDate = document.getElementById("delivery-date").value;

      if (!clientId || !deliveryDate) {
        alert("–ó–∞–ø–æ–≤–Ω–∏ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –∫–ª—ñ—î–Ω—Ç–∞ —ñ –¥–∞—Ç—É –¥–æ—Å—Ç–∞–≤–∫–∏!");
        return;
      }

      if (flowerList.length === 0) {
        alert("–¢–∏ –∂ –Ω–µ –¥–æ–¥–∞–≤ –∂–æ–¥–Ω–æ—ó –∫–≤—ñ—Ç–∫–∏ –¥–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è! üå∏");
        return;
      }

      const orderData = {
        clientId,
        deliveryDate,
        flowers: flowerList
      };

      console.log("–ù–æ–≤–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è:", orderData);

      alert("–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–≤–æ—Ä–µ–Ω–æ! (–ü–æ–∫–∏ —â–æ —Ç—ñ–ª—å–∫–∏ –≤ –∫–æ–Ω—Å–æ–ª—ñ üß™)");
      // –¢—É—Ç —Ç–∏ –º–æ–∂–µ—à –∑—Ä–æ–±–∏—Ç–∏ —Ä–µ–∞–ª—å–Ω–∏–π POST-–∑–∞–ø–∏—Ç —á–µ—Ä–µ–∑ fetch()
    });
  </script>

  <script src="plugins/jquery/dist/jquery.min.js"></script>
  <script src="plugins/bootstrap/js/bootstrap.min.js"></script>

  <script>
  // –ü–æ–∫–∞–∑—É—î–º–æ —Ä–æ–ª—å
  const user = JSON.parse(localStorage.getItem("user"));
  if (user?.role) {
    document.getElementById("user-role").textContent =
      user.role.charAt(0).toUpperCase() + user.role.slice(1);
  }

  // –û–±—Ä–æ–±–∫–∞ –∫–Ω–æ–ø–∫–∏ "–í–∏–π—Ç–∏"
  document.getElementById("logout-btn").addEventListener("click", () => {
    const confirmed = confirm("–í–∏ —Ç–æ—á–Ω–æ —Ö–æ—á–µ—Ç–µ –≤–∏–π—Ç–∏ –∑—ñ —Å–≤–æ–≥–æ –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É?");
    if (confirmed) {
      localStorage.removeItem("user");
      window.location.href = "index.html";
    }
  });
</script>
{% endblock %}